{{- if .Values.mtls.enabled }}
# =============================================================================
# ServersTransport for mTLS backend communication
# =============================================================================
# This ServersTransport configures Traefik to use mTLS when communicating
# with backend services. It includes:
# - Root CA certificate for validating server certificates
# - Client certificate for Traefik to present to backends
#
# Usage in IngressRoute (cross-namespace reference):
#   services:
#     - name: my-service
#       port: 8443
#       scheme: https
#       serversTransport: traefik-internal-mtls@kubernetescrd
# =============================================================================
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: internal-mtls
  labels:
    {{- include "traefik-options.labels" . | nindent 4 }}
spec:
  # Trust our internal CA for validating server certificates
  rootCAsSecrets:
    - {{ .Values.mtls.caBundleSecretName }}
  
  # Client certificate for Traefik to present to backends
  certificatesSecrets:
    - {{ .Values.mtls.clientCertSecretName }}
  
  # Skip hostname verification to support routing to multiple backend services.
  # CA verification still applies via rootCAsSecrets - each backend must present
  # a certificate signed by our internal CA.
  insecureSkipVerify: true
  
  forwardingTimeouts:
    dialTimeout: "30s"
    responseHeaderTimeout: "60s"
    idleConnTimeout: "90s"
{{- end }}
